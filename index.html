<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>è·å ´é€±å¹´ãƒ»æŠ“å‘¨ç¦®</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
    /* æ ¸å¿ƒæ¶æ§‹ */
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", "Noto Sans TC", "Segoe UI", sans-serif; }
    body { margin: 0; min-height: 100vh; background: radial-gradient(circle at center, #b43a3a 0%, #821c1c 100%); display: flex; justify-content: center; align-items: center; color: #2f3440; overflow: hidden; }
    .container { width: 95%; max-width: 450px; height: 92vh; background: #fffdf9; border-radius: 24px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.4); border: 6px solid #f2e1c1; display: flex; flex-direction: column; overflow-y: auto; position: relative; }
    .hidden { display: none !important; }
    .center { text-align: center; }

    /* æŒ‰éˆ•èˆ‡è¼¸å…¥ */
    .primary-btn { border: none; border-radius: 999px; padding: 16px; background: linear-gradient(135deg, #d44747, #a32a2a); color: #fff; font-size: 1.1rem; font-weight: bold; width: 100%; cursor: pointer; transition: 0.3s; box-shadow: 0 5px 15px rgba(130,28,28,0.3); margin-top: 10px; }
    .share-btn { background: #fff; color: #821c1c; border: 2px solid #821c1c; margin-top: 15px; }

    input { width: 100%; padding: 15px; border: 2px solid #f2e1c1; border-radius: 12px; text-align: center; font-size: 1.1rem; margin-bottom: 20px; outline: none; background: #fff; }

    /* æ•…äº‹æ²‰æµ¸å‹•ç•« (æ¥µé€Ÿç‰ˆ 0.5s) */
    .story-line { opacity: 0; transform: translateY(10px); transition: all 0.5s ease; margin-bottom: 12px; color: #821c1c; line-height: 1.8; font-size: 1.05rem; }
    .story-line.show { opacity: 1; transform: translateY(0); }
    .breath-highlight { color: #d44747; font-weight: bold; font-size: 1.15rem; margin-top: 20px; }

    /* åœ–ç¤ºå°ºå¯¸ */
    .ritual-icon { font-size: 8.5rem; cursor: pointer; transition: transform 0.2s; margin: 15px 0; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); display: block; text-align: center; }

    /* ç±³ç¯©å‘ˆç¾ï¼šå‘¼å¸ç‰©ä»¶ */
    .ceremony-altar { background: #fdf5e6 url('https://www.transparenttextures.com/patterns/woven.png'); border-radius: 50%; width: 310px; height: 310px; margin: 20px auto; position: relative; border: 4px solid #d4af37; display: flex; align-items: center; justify-content: center; flex-shrink: 0; animation: floatTray 4s ease-in-out infinite; }
    .items-circle-wrap { position: absolute; width: 100%; height: 100%; top: 0; left: 0; display: flex; align-items: center; justify-content: center; }
    .item { position: absolute; width: 56px; height: 56px; background: #fff; border-radius: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #eee; z-index: 10; margin-left: -28px; margin-top: -28px; animation: itemPulse 3s ease-in-out infinite; transition: 0.3s; }
    
    .item.selected { 
        background-color: #e0e0e0 !important; 
        filter: grayscale(1) opacity(0.4) !important; 
        pointer-events: none !important; 
        animation: none !important;
    }
    .item-inner { display: flex; flex-direction: column; align-items: center; pointer-events: none; width: 100%; height: 100%; justify-content: center; }

    /* å®‡å®™é¢¨æ ¼é¸å– */
    .theme-grid { display: flex; flex-direction: column; gap: 12px; margin: 15px 0; }
    .theme-btn { border: 2px solid #f2e1c1; border-radius: 18px; padding: 18px; background: #fff; cursor: pointer; display: flex; align-items: center; width: 100%; transition: 0.3s; }
    .theme-btn.active { border-color: #d44747; background: #fff5f5; border-width: 3px; transform: scale(1.02); }
    .theme-btn span { font-size: 2.2rem; margin-right: 18px; }
    .theme-btn b { color: #821c1c; font-size: 1.15rem; }

    /* ç´…é¾œç²¿ */
    .red-gui { background: #e65c5c; border-radius: 25px; padding: 20px 10px; text-align: center; color: white; cursor: pointer; box-shadow: 0 6px 0 #b33a3a; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .red-gui.active { background: #a32a2a; border: 2px solid #d4af37; transform: translateY(3px); box-shadow: 0 3px 0 #b33a3a; pointer-events: none; }

    /* å½ˆçª—è¨­è¨ˆ */
    .overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px; }
    .popup { background: #fff; border-radius: 24px; padding: 35px 25px; width: 90%; max-width: 380px; text-align: center; border-top: 10px solid #d44747; box-shadow: 0 20px 50px rgba(0,0,0,0.4); }
    .quote-card { background: #fff8f8; border: 2px solid #d44747; padding: 18px; border-radius: 16px; text-align: center; margin: 15px 0; }
    .seal-text { color: #d44747; font-weight: bold; margin-top: 10px; font-size: 1.1rem; letter-spacing: 2px; border-top: 1px dashed #d44747; padding-top: 10px; }

    /* è­‰æ›¸èˆ‡å‹•ç•« */
    .cert-section { opacity: 0; transform: translateY(10px); transition: 0.5s ease; }
    .cert-section.show { opacity: 1; transform: translateY(0); }
    .certificate { border: 4px solid #d4af37; padding: 22px; background: #fff; position: relative; text-align: left; width: 100%; margin-bottom: 20px; }
    .blessing-box { background: #fffaf5; padding: 20px; border-radius: 12px; margin-top: 15px; font-size: 0.95rem; line-height: 1.8; border: 2px solid #821c1c; }

    @keyframes floatTray { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    @keyframes itemPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.06); } }
</style>
</head>
<body>

<div class="container" id="app">
    <div id="stepName" class="step">
        <h1 class="center" style="color:#821c1c; font-size:1.8rem; margin-bottom:5px;">è·å ´é€±å¹´ãƒ»æŠ“å‘¨ç¦®</h1>
        <p class="center" style="font-style:italic; color:#821c1c; margin-bottom:30px;">ã€Œä¸€æ­²ä¸€ç¦®ï¼Œä¸€å¯¸æ­¡å–œã€</p>
        <p class="center" style="font-size:0.95rem; color:#666; margin-bottom:15px;">å„€å¼é–‹å§‹å‰ï¼Œè«‹ç•™ä¸‹ä½ çš„è·å ´åè™Ÿ</p>
        <input type="text" id="userInput" placeholder="ä¾‹å¦‚ï¼šæ•¸æ“šå‹‡è€… Alice">
        <button class="primary-btn" onclick="toStory()">å‚™ç¦®ãƒ»é–‹å§‹å„€å¼</button>
    </div>

    <div id="stepStory" class="step hidden center">
        <div id="storyContent">
            <p class="story-line">å¬°å…’æŠ“å‘¨ï¼Œæ…¶ç¥çš„æ˜¯å¹³å®‰é•·å¤§ã€‚</p>
            <p class="story-line">è·å ´æŠ“å‘¨ï¼Œè‡´æ•¬çš„æ˜¯â€”â€”ä»ç„¶é¡˜æ„å‰é€²çš„ä½ ã€‚</p>
            <p class="story-line">æ¯ä¸€ä½è·äººï¼Œåœ¨ç¬¬ä¸€å¹´ã€ç¬¬äº”å¹´ï¼Œç”šè‡³ç¬¬åå¹´ï¼Œéƒ½å€¼å¾—ä¸€æ¬¡é‡æ–°æ ¡æº–æ–¹å‘çš„æ™‚åˆ»ã€‚</p>
            <p class="story-line">ä»Šå¤©ï¼Œæˆ‘å€‘æš«æ™‚æ”¾ä¸‹æ—¥å¸¸çš„è§’è‰²èˆ‡ä»»å‹™ï¼Œæƒå»è·å ´çš„å¡µåŸƒï¼Œæ•´ç†å…§åœ¨çš„è¡£å† ã€‚</p>
            <p class="story-line">é€™ä¸æ˜¯å åœï¼Œè€Œæ˜¯ä¸€å ´ç‚ºè‡ªå·±è€Œåšçš„å„€å¼ã€‚</p>
            <p class="story-line">æ¥ä¸‹ä¾†çš„é¸æ“‡ï¼Œå°‡æ˜ ç…§ä½ æ­¤åˆ»çš„ç‹€æ…‹ï¼Œä¹ŸæŒ‡å¼•ä½ èµ°å‘ä¸‹ä¸€æ®µæ—…ç¨‹ã€‚</p>
            <p class="story-line breath-highlight">ç¾åœ¨ï¼Œè«‹é–‰ä¸Šçœ¼å‘¼å¸ä¸‰æ¬¡ï¼Œæº–å‚™é–‹å•Ÿä½ çš„è·å ´å®‡å®™ã€‚</p>
        </div>
        <button id="storyEndBtn" class="primary-btn hidden" onclick="toTheme()">æˆ‘æº–å‚™å¥½äº†</button>
    </div>

    <div id="stepTheme" class="step hidden">
        <p class="center" style="color:#821c1c; font-weight:bold; font-size:1.1rem;">é¸æ“‡æ¢ç´¢å®‡å®™é¢¨æ ¼ï¼š</p>
        <div id="themeButtons" class="theme-grid"></div>
        <button id="themeConfirmBtn" class="primary-btn" disabled onclick="toRobe()">é€²å…¥æº–å‚™æµç¨‹</button>
    </div>

    <div id="stepRobe" class="step hidden center">
        <p style="color:#821c1c; font-weight:bold; font-size:1.2rem; margin-bottom:15px;">è·å ´æŠ“å‘¨ãƒ»æˆè¢å„€å¼</p>
        <div style="font-size:0.95rem; color:#666; line-height:1.7; margin-bottom:15px; padding:0 10px;">
            å¬°å…’æŠ“å‘¨å‰æœƒå…ˆç©¿ä¸Šè™è¡£ï¼Œä¸¦éç‚ºäº†å¥½çœ‹ï¼Œè€Œæ˜¯è±¡å¾µä¸€ä»½å®ˆè­·â€”â€”ç‚ºå­©å­æŠ«ä¸Šä¸€å±¤é¢å°ä¸–ç•Œçš„å‹‡æ°£ã€‚<br><br>
            ä»Šæ—¥ï¼Œæˆ‘å€‘ä¹Ÿç‚ºè·äººæº–å‚™äº†å°ˆå±¬æˆ°è¢ã€‚<br>
            <span style="color:#821c1c; font-weight:bold;">é€™ä¸æ˜¯è£æ‰®ï¼Œè€Œæ˜¯ä¸€å ´èº«åˆ†çš„è½‰æ›ã€‚</span>
        </div>
        <div id="robeIcon" class="ritual-icon center" style="margin: 0 auto;" onclick="onRobeClick()"></div>
        <p id="robeLabel" style="font-weight:bold; color:#821c1c; font-size:1.15rem;"></p>
        <p style="color:#999; font-size:0.9rem;">(é»æ“ŠæŠ«æ›æˆ°è¢ï¼Œæ‰¿æ¥å®‡å®™åŠ›é‡)</p>
    </div>

    <div id="stepWarmupIntro" class="step hidden center">
        <p style="color:#821c1c; font-weight:bold; font-size:1.2rem; margin-bottom:15px;">è·å ´æŠ“å‘¨ãƒ»åƒç¦æ‘¸ç¦å„€å¼</p>
        <div style="color:#666; font-size:0.95rem; line-height:1.8; margin-bottom:30px; padding:0 20px;">
            å‚³çµ±æŠ“å‘¨ä¸­ï¼Œå­©å­æœƒåƒç¦ç‰©ã€æ‘¸å‰ç¥¥ï¼ŒæŠŠç¥ç¦ä¸€æ¨£ä¸€æ¨£ï¼Œæ”¾é€²æœªä¾†äººç”Ÿè£¡ã€‚<br><br>
            ä»Šå¤©ï¼Œæˆ‘å€‘ä¹Ÿç‚ºè·äººæº–å‚™äº†å±¬æ–¼è·å ´çš„ç¦ç‰©ã€‚<br>
            æ¯ä¸€æ¬¡å“åšã€è§¸ç¢°ï¼Œéƒ½æ˜¯ä¸€ç¨®<span style="color:#d44747; font-weight:bold;">èƒ½åŠ›çš„å¬å–š</span>ã€‚
        </div>
        <button class="primary-btn" onclick="startWarmup()">é–‹å§‹é ˜å—ç¦ç‰©</button>
    </div>

    <div id="stepWarmup" class="step hidden center">
        <p id="wTitle" style="color:#821c1c; font-size:1.6rem; font-weight:bold; margin-bottom:5px;"></p>
        <p id="wAction" style="font-size:1.1rem; color:#333;"></p>
        <div id="wIcon" class="ritual-icon center" style="margin: 0 auto;" onclick="onWarmupClick()"></div>
    </div>

    <div id="stepGame" class="step hidden">
        <h3 class="center" style="color:#821c1c; font-size:1.4rem; margin-bottom:5px;">é€±æ­²æ­£å…¸ãƒ»èˆ‰è¡ŒæŠ“å‘¨å„€å¼</h3>
        <p class="center" style="font-size:0.95rem; color:#666; margin-bottom:10px;">è«‹å¾ç±³ç¯©ä¸­æŠ“å– 3 ä»¶è·å ´å¯¶ç‰©</p>
        <div class="ceremony-altar"><div class="items-circle-wrap" id="itemGrid"></div></div>
    </div>

    <div id="stepFeet" class="step hidden">
        <p class="center" style="font-weight:bold; color:#821c1c; font-size:1.4rem; margin-bottom:10px;">è·äººè¶³è·¡ãƒ»æ­¥æ­¥ç”Ÿè¼</p>
        <p class="center" style="font-size:1.05rem; color:#666; margin-bottom:15px; padding:0 10px;">è«‹é»é¸å…©å€‹ç´…é¾œç²¿ï¼Œä»£è¡¨ä¾†å¹´æ­¥æ­¥è¸å¯¦ã€åœ“æ»¿æ–°å±€ã€‚</p>
        <div id="guiContainer" style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px; padding:0 10px;"></div>
    </div>

    <div id="stepCert" class="step hidden">
        <div id="certContainer"></div>
        <p class="center" style="font-size:0.85rem; color:#d44747; margin-bottom:5px;">âœ¨ å„€å¼åœ“æ»¿ã€‚é•·æŒ‰è¢å¹•æˆªåœ–ï¼Œåˆ†äº«ä½ çš„è·äººå‘½ç›¤ã€‚</p>
        <button class="primary-btn share-btn" onclick="copyLink()">ğŸ”— åˆ†äº«çµ¦è·äººå¤¥ä¼´</button>
        <button class="primary-btn" onclick="manualReset()">é‡æ–°æ¢ç´¢å®‡å®™</button>
    </div>
</div>

<div id="overlay" class="overlay hidden">
    <div class="popup">
        <div id="popupBody"></div>
        <button id="popCloseBtn" class="primary-btn" style="width:auto; padding:12px 50px; margin-top:20px;" onclick="closePopup()">ç¹¼çºŒå„€å¼</button>
    </div>
</div>

<script>
// --- è³‡æ–™åº« (å®Œæ•´) ---
const ITEM_DB = {
    "é’è”¥": { emoji: "ğŸ§…", trad: "è°æ˜ç¿è¦º", quotes: ["é‡æ¸…ä¾›æ‡‰éˆç¯€é»è„ˆçµ¡ï¼Œå»ºç«‹ç²¾å¯†é‹ç±Œåº§æ¨™ï¼Œå±•ç¾é åˆ¤é˜»å¡ä¹‹æ™ºæ…§ã€‚","è¦ºçŸ¥å°èˆªå…ˆæ©Ÿï¼Œæ–¼æ··äº‚ä¸­é‡æ¸…æ ¸å¿ƒé‚è¼¯ã€‚","ç´°è†©æ„ŸçŸ¥ç’°å¢ƒå¾®å…‰ï¼ŒåŒ–è§£åƒµå±€ã€‚","ç²¾æº–é–å®šå±€å‹¢ç ´ç¶»ï¼Œè§£é–å‚³å¥‡ã€‚","çœ‹ç©¿è·å ´ç•«é¤…è™›åƒï¼Œç²¾ç¢ºé–å®šç²å‹è·¯å¾‘ã€‚"] },
    "èŠ¹èœ": { emoji: "ğŸ¥¬", trad: "å‹¤å‹è¸å¯¦", quotes: ["ç²¾å¯†ç©©å®šååè²¨æµï¼Œæˆç‚ºç³»çµ±å¯é åœ°åŸºã€‚","è…³è¸å¯¦åœ°ç£¨ç·´åº•æ°£ï¼Œè®“æ¯æ­¥ç´¯ç©éƒ½æˆç‚ºå¯¦åŠ›ã€‚","ç¶­æŒå„ªé›…ç¯€å¾‹ï¼Œæ»‹é¤Šå…§åœ¨éŸŒæ€§ã€‚","ç¢ºä¿æŒçºŒæˆ°é¬¥è¼¸å‡ºåŠ›ï¼ŒåŒ–èº«åœ˜éšŠå®šå¿ƒä¸¸ã€‚","ç²¾æº–ç´¯ç©éš¨æ™‚é–ƒäººçš„è³‡æœ¬ï¼Œæ‹’çµ•çå¿™ã€‚"] },
    "æ›¸æœ¬": { emoji: "ğŸ“˜", trad: "åšå­¸å»£è¨˜", quotes: ["å…§åŒ–ç‰©æµSOPç‚ºæ ¸å¿ƒç«¶çˆ­åŠ›ï¼Œå»ºç«‹å°ˆæ¥­è­·åŸæ²³ã€‚","å»£è¨˜è¡Œäº‹è„ˆçµ¡ï¼Œå…§åŒ–çŸ¥è­˜ç‚ºäººæ ¼æ·±åº¦ã€‚","é€éå­¸ç¿’ç‚ºç”Ÿå‘½é–‹æ‹“æ–°å±€ã€‚","ç²¾é€šè¦å‰‡è½‰åŒ–ç‚ºæ­¦åŠ›ï¼Œè§£é–è´å®¶æ¬ŠåŠ›ã€‚","æ·±çŸ¥çŸ¥è­˜å³è‡ªç”±ï¼Œå°ˆæ¥­ç©ç´¯æ˜¯è·æ¶¯ä¿éšªã€‚"] },
    "é‹¼ç­†": { emoji: "âœ’ï¸", trad: "å¦™ç­†ç”ŸèŠ±", quotes: ["å®šç¾©æ•¸æ“šå°æ¥æ¨™ç«¿ï¼Œåœ¨ç¹è¤‡æ•¸æ“šä¸­ç™¼æ®å½±éŸ¿åŠ›ã€‚","ä¸‹ç­†æœ‰ç¥è¨€ä¹‹æœ‰æ“šï¼Œåœ¨é ˜åŸŸå…§å»ºç«‹å½±éŸ¿ã€‚","æ•æ‰æ··äº‚ä¸­ç§©åºç¾ï¼Œé€éæ–‡å­—å‚³éé‚è¼¯ã€‚","å…·å‚™ç· çµå¥‘ç´„é ˜è¢–ç‰¹è³ªï¼Œä½¿å°ˆæ¥­è¦‹è§£è¢«ä¸–ç•Œè½è¦‹ã€‚","ç²¾é€šå„ªé›…æºé€šæŠ€è¡“ï¼Œç”¨ç¨ç‰¹æƒ³æ³•åŒ–è§£äººäº‹ã€‚"] },
    "å°º": { emoji: "ğŸ“", trad: "è¡Œäº‹æ­£ç›´", quotes: ["å®ˆè­·äº¤ä»˜å“è³ªé˜²ç·šï¼Œåœ¨è¦ç¯„ä¸­å±•ç¾è·äººé¢¨éª¨ã€‚","æ–¼å½ˆæ€§èˆ‡åŸå‰‡é–“æŒæ¡ç¶“ç·¯ï¼Œè´å¾—é•·ä¹…ä¿¡è³´ã€‚","æŒæ¡æ‹¿æç•Œç·šè—è¡“ï¼Œåœ¨ç´›æ“¾ä¸­å®ˆè­·åˆå¿ƒã€‚","ç²¾æº–è¡¡é‡è·å ´åˆ†å¯¸ï¼Œè®“åŸå‰‡æˆç‚ºæœ€å …å¯¦ç›”ç”²ã€‚","å¿ƒä¸­æœ‰æŠŠæ¸…é†’ä¹‹å°ºï¼Œæ´»å¾—å¿ƒä¸­æœ‰æ•¸ã€‚"] },
    "ç·šåœ˜": { emoji: "ğŸ§µ", trad: "é€£ç¶¿é•·ä¹…", quotes: ["é«˜æ•ˆå°æ¥è·¨éƒ¨è³‡æºï¼Œé”æˆè³‡è¨Šèˆ‡è²¨æµå®Œç¾éˆçµã€‚","å»£çµå–„ç·£å¾—ç¾¤åŠ›æ”¯æŒï¼Œç¹”å°±å·¦å³é€¢æºè²´äººç¶²ã€‚","ç‰½èµ·æº«æš–è¼•ç›ˆé€£çµï¼Œä¸²æ¥ç¹é›œéœ€æ±‚ç‚ºåœ“æ»¿ã€‚","è·¨ç•Œçªåœæ•´åˆå¤©è³¦ï¼Œå€æ•¸å¢ç›Šåœ˜éšŠæˆ°ã€‚","æ¥µå¼·æ•´åˆèƒ½åŠ›ï¼Œç¢ºä¿é›œäº‹ä¸ç³¾çºã€‚"] },
    "é¡å­": { emoji: "ğŸª", trad: "æ˜è¾¨æ˜¯é", quotes: ["å¯¦æ™‚åé¥‹é‹ä½œæ•ˆèƒ½ï¼Œè¿½æ±‚æ¥µè‡´è¿­ä»£ã€‚","æ­£è¡£å† å¯Ÿå…§å¿ƒï¼Œæ„Ÿè¬ç¶“æ­·å°åˆå¿ƒçš„æ˜ ç…§ã€‚","çµ¦äºˆé€™ä¸€å¹´æœ€é«˜è‚¯å®šï¼Œçœ‹è¦‹åŠªåŠ›çš„è‡ªæˆ‘ã€‚","æ´ç©¿è™›å½çœŸç†ä¹‹çœ¼ï¼Œåœ¨è‡ªæˆ‘æ›´æ–°ä¸­è®Šå¼·ã€‚","çœ‹æ¸…ç¾å¯¦å¾Œä¾ç„¶èªå¯è‡ªèº«åƒ¹å€¼ã€‚"] },
    "æ¢³å­": { emoji: "ğŸª®", trad: "ç†è·¯é€šé †", quotes: ["æ¢³ç†æ··äº‚ç‰©æµæµç¨‹ï¼Œè®“é˜»å¡æ’ç¨‹æ¢å¾©æµæš¢ã€‚","å°‡è¤‡é›œå±€é¢è½‰åŒ–ç‚ºåº·èŠå¤§é“ï¼Œè®“è·æ¶¯é †å¿ƒã€‚","æ¢³ç†ç„¦æ…®æƒ…ç·’ï¼Œåœ¨å¿™ç¢Œä¸­ä¿æœ‰èˆ’å¿ƒç¯€å¾‹ã€‚","è§£ææ”»ç•¥ç°¡åŒ–æœ¬é ˜ï¼Œè®“å•é¡Œè¿åˆƒè€Œè§£ã€‚","ç¶­æŒé«®å‹ä¸äº‚é«”é¢åº•æ°£ï¼ŒæŒæ§å…¨å ´æ–¼æŒ‡å°–ã€‚"] },
    "éˆ´éº": { emoji: "ğŸ””", trad: "ä¸€é³´é©šäºº", quotes: ["å»ºç«‹ç•°å¸¸é è­¦æ©Ÿåˆ¶ï¼Œç‚ºåœ˜éšŠå®‰å…¨æŒ‡æ¨™ã€‚","å»ºç«‹ç„¡å¯æŒ‘æˆ°é ˜è¢–åœ°ä½ï¼Œåå‚³åƒé‡Œã€‚","æˆç‚ºå®‰ç©©äººå¿ƒä¹‹å°ˆæ¥­å®åš€ï¼Œç”¨è²æœ›å®ˆè­·å½¼æ­¤ã€‚","é—œéµæ™‚åˆ»åŒ–èº«é˜²ç¦¦å¡”ï¼Œå®ˆè­·åœ˜éšŠæˆæœã€‚","å®ˆè­·ä¸‹ç­é˜éŸ¿æ¬Šåˆ©ï¼Œæ“æœ‰ç”Ÿæ´»æŒæ§æ¬Šã€‚"] },
    "é‹å­": { emoji: "ğŸ‘Ÿ", trad: "æ­¥å±¥åƒé‡Œ", quotes: ["è¸å¯¦èµ°å®Œæœ€å¾Œä¸€å“©è·¯ï¼Œç”¨å¯¦è¸åŠ›è´å¾—é•·ä¹…ä¿¡ã€‚","æ­¥å±¥è¼•ç›ˆå¿—åœ¨é æ–¹ï¼Œè…³è¸å¯¦åœ°èµ°å‡ºå‰ç¨‹ã€‚","å…·å‚™çœ‹æ¸…ç¾å¯¦ä¾ç„¶å‰è¡Œçš„å¾å®¹ã€‚","å‹‡æ–¼è·¨å‡ºèˆ’é©åœˆï¼Œå°‡ä¸å¯èƒ½è½‰åŒ–ç‚ºå‚³å¥‡ã€‚","ç¹«å¥½é‹å¸¶è¸å¯¦å‰è¡Œï¼Œç¶­æŒå‰é€²å¼·éŸŒæ€§ã€‚"] },
    "æ¹¯åŒ™": { emoji: "ğŸ¥„", trad: "ç¦ç¥¿æ»‹é¤Š", quotes: ["å„ªåŒ–åˆä½œä»‹é¢ï¼Œæˆç‚ºé—œéµæ½¤æ»‘åŠ‘ï¼Œæ¸›å°‘ç£¨æã€‚","å»£ç´ç¦æ°£æ»‹é¤Šå–œæ‚…ï¼Œç²å–è·æ¶¯èƒ½é‡å›é¥‹ã€‚","åœ¨ç…§çœ‹ä»–äººä¹‹æ™‚äº¦ä¸å¿˜æ»‹é¤Šè‡ªå·±ã€‚","å›è£œæˆ°é¬¥åŠ›è—¥æ°´ï¼Œç¢ºä¿å¤§å®¶æ“æœ‰æŒçºŒåŠ›ã€‚","é¤µé£½è‚šå­ï¼Œæ›´æœ‰åŠ›æ°£å»é¤µé£½ç†±è¡€å¤¢æƒ³ã€‚"] },
    "å¸ƒå¶": { emoji: "ğŸ§¸", trad: "èµ¤å­åˆå¿ƒ", quotes: ["å†°å†·æ•¸æ“šä¸­ä¿æœ‰æº«åº¦ï¼Œè®“å°ˆæ¥­æœå‹™å…·è³ªæ„Ÿã€‚","ä¿æœ‰èµ¤å­åˆå¿ƒï¼Œåœ¨æ¿€çƒˆç«¶çˆ­ä¸­æ´»å‡ºè³ªæ„Ÿã€‚","æ“æœ‰ä¸€ä»½ä¸è¢«åŒåŒ–ä¹‹æŸ”è»Ÿï¼Œå®ˆè­·åˆå¿ƒã€‚","å®ˆè­·ä¸æœè¼¸é¬¥å¿—ï¼Œè§£é–æº«æŸ”å¼·å¤§ã€‚","ç´¯çš„æ™‚å€™ä¾ç„¶èƒ½çœ‹è¦‹ä¸–ç•Œå¯æ„›ã€‚"] },
    "é£›æ©Ÿ": { emoji: "âœˆï¸", trad: "å¿—åœ¨é›²ç«¯", quotes: ["æ“æœ‰å…¨çƒé‹ç±Œè¦–é‡ï¼Œä½¿è·æ¶¯è³½é“ç„¡é™å¯¬å»£ã€‚","å±•ç¾ç„¡å¯é™é‡æœªä¾†æ ¼å±€ï¼Œåœ¨é«˜è™•çœ‹è¦‹æ©Ÿæœƒã€‚","å¾é›²ç«¯ä¿¯ç°ä¸–ç•Œè§€ï¼Œç”¨é«˜åº¦è§£æ±ºç‘£äº‹ã€‚","è®“æ¯ä¸€æ¬¡é¸æ“‡çš†å…·æˆ°ç•¥é¬¥å¿—ï¼Œè·æ¶¯èºé·ã€‚","çœ¼ç•Œå®å¤§æ ¼å±€æ¸…æ™°ï¼Œç›®æ¨™æ°¸é åœ¨æ›´é«˜é›²ç«¯ã€‚"] }
};

const THEMES = [
    { name: "ç‰©æµè·äººç‰ˆ", icon: "ğŸ“¦", wishes: "ç²¾æº–æŠµé”ï¼Œæºæ–¼æ¯ä¸€ç§’çš„å …æŒã€‚", robe: "å„ªé›…è·äººè¥¿è£", robeIcon: "ğŸ‘”", pos: "ç§©åº Ã— ç²¾æº– Ã— ç³»çµ±æ ¸å¿ƒ", bless: "æŠ«ä¸Šæ­¤è£ï¼Œåº§æ¨™å³å®šã€‚é¡˜ä½ ä»¥é‚è¼¯ç‚ºç›¾ï¼Œç²¾æº–ç‚ºåˆƒï¼Œå°‡è¤‡é›œåŒ–ç‚ºç§©åºã€‚", strategy: [{l:"å·¦è¸ãƒ»å¹³å®‰", s:"åŸºçŸ³ç±¤", j:"åœ°è‹¥ç©©ï¼Œè·¯è‡ªé€š", d:"ä½ æ­¤åˆ»æœ€è©²åšçš„ï¼Œä¸æ˜¯è¡æœ€å¿«ï¼Œè€Œæ˜¯æŠŠåœ°åŸºæŒ–æ·±ã€‚ç•¶ä½ çœŸæ­£è®€æ‡‚ç³»çµ±è„ˆçµ¡ï¼Œåˆ¥äººå‹•ç›ªï¼Œä½ è‡ªå®‰ç©©ã€‚"},{l:"å³è¸ãƒ»å¯Œè²´", s:"æ ¡æº–ç±¤", j:"å¿ƒè‹¥æº–ï¼Œé‡è‡ªé–‹", d:"ç¦ä¸åœ¨å¤šå¿™ï¼Œè€Œåœ¨å‰›å¥½ã€‚ç•¶ä½ çœ‹æ¸…è‡ªå·±æ‰¿è¼‰çš„é‡ï¼Œåˆªå»é›œè¨Šï¼Œç”¢å‡ºè‡ªç„¶ä¸Šå‡ã€‚"},{l:"æ­¥æ­¥è¸å¯¦", s:"éˆçµç±¤", j:"ç¨è¡Œæ˜“æ…¢ï¼Œçµç¶²å‰‡å¿«", d:"ä¸»å‹•ä¸²é€£é—œéµè§’è‰²ï¼Œæœƒæ‰“é–‹åŸæœ¬çœ‹ä¸è¦‹çš„æ·å¾‘ã€‚"},{l:"å‰ç¨‹ä¼¼éŒ¦", s:"çºŒèˆªç±¤", j:"å°ˆæ¥­å³é•·æœŸæˆ°åŠ›", d:"æœƒè·‘çš„äººå¾ˆå¤šï¼Œèƒ½è·‘ä¹…çš„äººä¸å¤šã€‚æ‡‚å¾—åˆ‡æ›ç¯€å¥è€…ï¼Œæ‰èƒ½èµ°å¾—æ›´é ã€‚"}] },
    { name: "å‚³çµ±å¤§å‰ç‰ˆ", icon: "ğŸ§§", wishes: "å‡¡éå¾€çš†ç‚ºåºç« ï¼Œé¡˜ä½ æœªä¾†ç¶»æ”¾å…‰èŠ’ã€‚", robe: "å¦‚æ„è·äººé•·è¢", robeIcon: "ğŸ‘˜", pos: "ç¦é‹ Ã— ç©©å®š Ã— å¤©æ™‚åœ°åˆ©", bless: "è¢è¢–ä¸€å±•ï¼Œç¦æ°£éš¨è¡Œã€‚é¡˜æ­¤é•·è¢ç‚ºä½ æ“‹é¢¨é¿é›¨ï¼Œè®“åŠªåŠ›è‡ªæœ‰å›éŸ¿ã€‚", strategy: [{l:"å·¦è¸ãƒ»å¹³å®‰", s:"æ ¹æ°£ç±¤", j:"ç©©å­—ç•¶é ­ï¼Œç¦è‡ªéš¨è¡Œ", d:"ä½ æ­£åœ¨ç´¯ç©çœ‹ä¸è¦‹çš„åšåº¦ã€‚é€™ä»½ç©©ï¼Œæœªä¾†æ­£æ˜¯ä½ æœ€é›£è¢«å–ä»£çš„åº•æ°£ã€‚"},{l:"å³è¸ãƒ»å¯Œè²´", s:"æ¸…æ˜ç±¤", j:"è«éš¨äººæ½®èµ·ä¼", d:"æ¸…æ¥šè‡ªå·±æ˜¯èª°ã€èƒ½åšä»€éº¼ï¼Œæ¯”çŸ­æš«æŒè²æ›´å€¼éŒ¢ã€‚"},{l:"æ­¥æ­¥è¸å¯¦", s:"äººå’Œç±¤", j:"ç¦æ°£è—åœ¨äººå’Œè£¡", d:"ç•¶ä½ é¡˜æ„ä¼¸æ‰‹ï¼ŒåŠ©åŠ›ä¹Ÿæœƒå›é ­æ‰¾ä¸Šä½ ã€‚"},{l:"å‰ç¨‹ä¼¼éŒ¦", s:"ä¹…è¡Œç±¤", j:"æ­¥æ­¥ç‚ºç‡Ÿï¼Œä¹…è¡Œè‡ªé ", d:"ä¸å¿…è¿½æœ€å¿«çš„é‚£æ¢è·¯ã€‚æ‰¾å°è‡ªå·±çš„æ­¥é€Ÿï¼Œæ™‚é–“è‡ªç„¶æ›¿ä½ ç´¯ç©æˆæœã€‚"}] },
    { name: "æº«æŸ”æ²»ç™’ç‰ˆ", icon: "ğŸŒ¿", wishes: "é¡˜ä½ å¿™ç¢Œæ™‚ä¾ç„¶æœ‰è©©ï¼Œç–²æ†Šæ™‚æœ‰äººæ“æŠ±ã€‚", robe: "æš–å¿ƒå®ˆè­·æ–—ç¯·", robeIcon: "ğŸ§¥", pos: "å…§åœ¨å®‰å®š Ã— ä¿®å¾© Ã— ç¯€å¥", bless: "æŸ”è»Ÿåœ¨èº«ï¼Œæœ¬å¿ƒä¸å¤±ã€‚é¡˜é€™ä»½æº«æš–å®ˆè­·ä½ ï¼Œåœ¨é«˜å£“èˆ‡å¿™ç¢Œé–“ï¼Œè½è¦‹è‡ªå·±çš„è²éŸ³ã€‚", strategy: [{l:"å·¦è¸ãƒ»å¹³å®‰", s:"ç´®æ ¹ç±¤", j:"æŸ”è€…ä¸å¼±ï¼Œæ…¢è€…ä¸é€€", d:"ç¾åœ¨åšçš„äº‹ä¹Ÿè¨±æ²’äººçœ‹è¦‹ã€‚ä½†æ ¹æ‰å¾—æ·±ï¼Œæœªä¾†çš„é¢¨é›¨éƒ½åªæ˜¯èƒŒæ™¯ã€‚"},{l:"å³è¸ãƒ»å¯Œè²´", s:"ç•™ç™½ç±¤", j:"åœä¸€ä¸‹ï¼Œä¸¦éå¾Œé€€", d:"çµ¦è‡ªå·±å‘¼å¸çš„ç©ºé–“ï¼Œç­”æ¡ˆæ‰æœƒæµ®ç¾ã€‚"},{l:"æ­¥æ­¥è¸å¯¦", s:"åŒè¡Œç±¤", j:"é »ç‡ç›¸è¿‘è€…åŒè¡Œ", d:"é€™æ¢è·¯ä¸é©åˆç¨èµ°ã€‚ç•¶ä½ æ‰¾åˆ°ä¼´ï¼Œäº‹æƒ…æœƒè®Šå¾—ä¸å†é‡ã€‚"},{l:"å‰ç¨‹ä¼¼éŒ¦", s:"ç¯€å¥ç±¤", j:"ç”¨è‡ªå·±çš„ç¯€æ‹å‰è¡Œ", d:"ä¸å¿…æ´»æˆåˆ¥äººçš„æœŸå¾…ã€‚ä½ çš„äººç”Ÿï¼Œæœ‰æ¬Šåˆ©ç”¨è‡ªå·±çš„ç¯€æ‹å‰è¡Œã€‚"}] },
    { name: "ç†±è¡€å†’éšªç‰ˆ", icon: "âš”ï¸", wishes: "ä½ çš„å¾é€”æ˜¯æ˜Ÿè¾°å¤§æµ·ï¼Œä¸‹ä¸€ç«™ï¼Œå‚³å¥‡é–‹å§‹ã€‚", robe: "å‚³å¥‡å†’éšªé ˜å·¾", robeIcon: "ğŸ§£", pos: "çªç ´ Ã— è¡Œå‹• Ã— è‹±é›„æ—…ç¨‹", bless: "é ˜å·¾ç¹«ä¸Šï¼Œå¾é€”å•Ÿç¨‹ã€‚é¡˜ä½ èƒ¸æ‡·é æ™¯ï¼Œè…³è¸æœªçŸ¥ï¼ŒæŠŠæŒ‘æˆ°ç•¶ä½œå¬å–šã€‚", strategy: [{l:"å·¦è¸ãƒ»å¹³å®‰", s:"è“„å‹¢ç±¤", j:"å¿ä¸€æ™‚è“„åŠ›ï¼Œæ›ä¸€æ“Šç ´å±€", d:"ä½ æ­£åœ¨é›éŠæ ¸å¿ƒèƒ½åŠ›ã€‚å¿ä¸€æ™‚è“„åŠ›ï¼Œé€™æœƒæˆç‚ºç¿»ç›¤é—œéµã€‚"},{l:"å³è¸ãƒ»å¯Œè²´", s:"æº–æ˜Ÿç±¤", j:"åˆ¥å†äº‚ç ï¼Œç²¾æº–é–å®š", d:"æŠŠåŠ›æ°£é›†ä¸­åœ¨æœ€æœ‰å‹ç‡çš„æ–¹å‘ï¼Œæˆæœæœƒä¾†å¾—å¿«åˆç‹ ã€‚"},{l:"æ­¥æ­¥è¸å¯¦", s:"çµ„éšŠç±¤", j:"è¯æ‰‹å°çš„äººï¼Œé›£åº¦ä¸‹é™", d:"å¼·è€…æ‡‚å¾—é¸éšŠå‹ã€‚è¯æ‰‹å°çš„äººï¼Œå‰¯æœ¬é›£åº¦è‡ªç„¶ä¸‹é™ã€‚"},{l:"å‰ç¨‹ä¼¼éŒ¦", s:"æˆ°ç•¥ç±¤", j:"æ‡‚å¾—é€²é€€ï¼Œæ‰æ˜¯é«˜æ‰‹", d:"æœƒè¡ä¹Ÿæœƒåœçš„äººï¼Œæœ€å¾Œæ‰èƒ½å¯«ä¸‹å‚³å¥‡ç´€éŒ„ã€‚"}] },
    { name: "å¹½é»˜é‡‘å¥ç‰ˆ", icon: "â˜•", wishes: "å„ªé›…æ‰“å·¥ï¼Œæ…¶ç¥å®Œé€™ç§’ï¼Œæº–æ™‚ä¸‹ç­ã€‚", robe: "è¬èƒ½å·¥è£èƒŒå¿ƒ", robeIcon: "ğŸ¦º", pos: "äººé–“æ¸…é†’ Ã— ç”Ÿå­˜æ™ºæ…§ Ã— è¼•ç›ˆå‰è¡Œ", bless: "å£è¢‹åœ¨æ‰‹ï¼Œäººç”Ÿä¸æ…Œã€‚é¡˜ä½ è£å¾—ä¸‹å°ˆæ¥­ä¹Ÿè£å¾—ä¸‹å¹½é»˜ã€‚æº–æ™‚ä¸‹ç­çš„è·¯ä¸Šï¼Œé¢¨ç¸½æ˜¯ç«™åœ¨ä½ é€™é‚Šã€‚", strategy: [{l:"å·¦è¸ãƒ»å¹³å®‰", s:"éµé£¯ç¢—ç±¤", j:"å¯¦åŠ›å¤ ç¡¬ï¼Œä¸–ç•Œå°±å®¢æ°£", d:"ç•¶ä½ çš„å°ˆæ¥­å¤ ç¡¬ï¼Œä¸–ç•Œè‡ªç„¶å°ä½ å®¢æ°£ã€‚é€™ä¸æ˜¯ä¿å®ˆï¼Œæ˜¯å¯¦åŠ›ã€‚"},{l:"å³è¸ãƒ»å¯Œè²´", s:"æ‹’å·¥ç±¤", j:"å¿™ç¢Œä¸ç­‰æ–¼æœ‰ç”¨", d:"çœ‹æ¸…å“ªäº›äº‹ä¸æœƒç´¯ç©ï¼Œæ”¾ä¸‹å®ƒï¼Œæ˜¯æˆç†Ÿçš„é–‹å§‹ã€‚"},{l:"æ­¥æ­¥è¸å¯¦", s:"äº’æ•‘ç±¤", j:"æˆå¹´äººçš„è‡ªæ•‘è¡“", d:"å£“åŠ›æœ‰äººåˆ†ï¼Œäººç”Ÿæ¯”è¼ƒæ’å¾—ä¹…ã€‚å»ºç«‹æ”¯æ´ç¶²æ˜¯æˆå¹´äººçš„è‡ªæ•‘è¡“ã€‚"},{l:"å‰ç¨‹ä¼¼éŒ¦", s:"é«˜æ®µä½ç±¤", j:"èººå¹³æ˜¯ç‚ºäº†çºŒå‘½", d:"å¶çˆ¾èººå¹³ä¸æ˜¯æ”¾æ£„ï¼Œæ˜¯çºŒå‘½ã€‚èµ°å¾—èˆ’æœï¼Œæ‰èƒ½èµ°åˆ°æœ€å¾Œã€‚"}] }
];

const WARMUP_POOL = [
    { id: "apple", icon: "ğŸ", action: "å’¬ä¸€å£ç´…è˜‹æœ", title: "æ­²æ­²å¹³å®‰", symbol: "æ¸…æ˜ Ã— å®‰ç©© Ã— çœ‹æ¸…å±€å‹¢", meanings: ["é‡æ¸…é—œéµæ’ç¨‹ï¼Œé åˆ¤ç“¶é ¸é˜»å¡ã€‚","éˆå°æ¸…æ˜ï¼Œæ­¥ä¼ä¸äº‚ã€‚","è¨˜å¾—ç‚ºè‡ªå·±ç•™ä¸€å£å‘¼å¸ç©ºé–“ã€‚","çœ‹ç©¿æ•µé™£ç ´ç¶»ï¼Œä¸€æ“Šçªç ´ã€‚","ä¸€å£å’¬ä¸‹ï¼Œç•«é¤…ç„¡æ‰€éå½¢ã€‚"] },
    { id: "chicken", icon: "ğŸ—", action: "åƒä¸€å£é‡‘é›è…¿", title: "ç¦ç¥¿é›™å…¨", symbol: "èƒ½é‡ Ã— åº•æ°£ Ã— æˆé•·çºŒèˆª", meanings: ["è£œè¶³ç³»çµ±å‹•èƒ½ï¼Œç©©å®šè¼¸å‡ºã€‚","åº•æ°£ç´®å¯¦ï¼Œç¦ç¥¿éš¨è¡Œã€‚","æº«æŸ”é¤µé¤Šæ­£åœ¨æˆé•·çš„è‡ªå·±ã€‚","è“„ç©åŠ›é‡ï¼Œç‚ºä¸‹ä¸€æ¬¡çˆ†ç™¼æº–å‚™ã€‚","é›è…¿ä¸€å®šè¦åƒå®Œã€‚"] },
    { id: "gong", icon: "ğŸ””", action: "æ•²éŸ¿é‡‘éŠ…é‘¼", title: "ä¸€é³´é©šäºº", symbol: "è²æœ› Ã— å…±æŒ¯ Ã— è¢«çœ‹è¦‹", meanings: ["å°ˆæ¥­å›éŸ¿ï¼Œå¨æœ›å‚³éå…¨éˆã€‚","äº‹æ¥­æ•²éŸ¿å¥½é‹ï¼Œåè²è‡ªå‚³ã€‚","æ‰¾åˆ°èˆ‡å…§å¿ƒä¸€è‡´çš„é »ç‡ã€‚","å‚³å¥‡ç™»å ´ï¼Œå…¨å ´ç„¦é»ã€‚","å®£å‘Šå„ªé›…ä¸‹ç­ã€‚"] }
];

let userName = "", themeIdx = -1, pickedItems = [], pickedFeets = [], selectedWarmups = [], wIdx = 0;

function toStory() {
    userName = document.getElementById('userInput').value.trim();
    if (!userName) return alert("è«‹ç•™ä¸‹åè™Ÿ");
    document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
    document.getElementById('stepStory').classList.remove('hidden');
    const lines = document.querySelectorAll('.story-line');
    lines.forEach((line, index) => {
        setTimeout(() => {
            line.classList.add('show');
            if(index === lines.length - 1) document.getElementById('storyEndBtn').classList.remove('hidden');
        }, index * 500); 
    });
}

function toTheme() {
    document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
    document.getElementById('stepTheme').classList.remove('hidden');
    const container = document.getElementById('themeButtons');
    container.innerHTML = "";
    THEMES.forEach((t, i) => {
        const btn = document.createElement('button');
        btn.className = 'theme-btn';
        btn.innerHTML = `<span>${t.icon}</span><b>${t.name}</b>`;
        btn.onclick = () => {
            themeIdx = i;
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('themeConfirmBtn').disabled = false;
        };
        container.appendChild(btn);
    });
}

function toRobe() {
    document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
    document.getElementById('stepRobe').classList.remove('hidden');
    document.getElementById('robeIcon').innerText = THEMES[themeIdx].robeIcon;
    document.getElementById('robeLabel').innerText = `æŠ«æ›ï¼š${THEMES[themeIdx].robe}`;
}

function onRobeClick() {
    const t = THEMES[themeIdx];
    showPopup(`<div style="font-size:0.9rem; color:#999; margin-bottom:5px;">${t.name}</div><h3 style="color:#821c1c; margin-top:0;">${t.pos}</h3><div class="quote-card"><b style="color:#d44747;">âš”ï¸ æŠ«æ›ç¥ç¦</b><p style="text-align:left; font-size:1rem; margin-top:10px; line-height:1.7;">${t.bless}</p></div>`);
    document.getElementById('popCloseBtn').innerText = "æ‰¿æ¥ç¥ç¦ï¼Œé–‹å•Ÿç¥ˆç¦";
    document.getElementById('popCloseBtn').onclick = () => { closePopup(); toWarmupIntro(); };
}

function toWarmupIntro() {
    document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
    document.getElementById('stepWarmupIntro').classList.remove('hidden');
}

function startWarmup() {
    wIdx = 0;
    selectedWarmups = [...WARMUP_POOL];
    document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
    document.getElementById('stepWarmup').classList.remove('hidden');
    renderWarmup();
}

function renderWarmup() {
    const stage = selectedWarmups[wIdx];
    document.getElementById('wTitle').innerText = stage.title;
    document.getElementById('wAction').innerText = `è«‹é»æ“Š${stage.action}`;
    document.getElementById('wIcon').innerText = stage.icon;
}

function onWarmupClick() {
    const stage = selectedWarmups[wIdx];
    showPopup(`<div style="font-size:0.9rem; color:#999; margin-bottom:5px;">${stage.icon} ${stage.title}</div><h3 style="color:#821c1c; margin-top:0;">è±¡å¾µï¼š${stage.symbol}</h3><div class="quote-card"><b style="color:#d44747;">âœ¨ è·å ´ç¦ç‰©ãƒ»ç¥ˆç¦ç®´è¨€</b><p style="text-align:left; font-size:1rem; margin-top:10px; line-height:1.7;">${stage.meanings[themeIdx]}</p></div>`);
    document.getElementById('popCloseBtn').innerText = (wIdx >= 2) ? "èƒ½åŠ›å°±ä½ï¼Œé€²å…¥æŠ“å‘¨" : "ç¹¼çºŒé ˜å—ç¦ç‰©";
    document.getElementById('popCloseBtn').onclick = () => { closePopup(); wIdx++; if (wIdx >= 3) toGame(); else renderWarmup(); };
}

function toGame() {
    document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
    document.getElementById('stepGame').classList.remove('hidden');
    const grid = document.getElementById('itemGrid');
    grid.innerHTML = "";
    Object.keys(ITEM_DB).forEach((name, i) => {
        const angle = (i / 13) * 2 * Math.PI;
        const x = Math.cos(angle) * 125, y = Math.sin(angle) * 125;
        const div = document.createElement('div');
        div.className = 'item';
        div.style.left = `calc(50% + ${x}px)`;
        div.style.top = `calc(50% + ${y}px)`;
        const data = ITEM_DB[name];
        div.innerHTML = `<div class="item-inner"><span>${data.emoji}</span><div style="font-size:0.6rem; font-weight:bold;">${name}</div></div>`;
        div.onclick = () => {
            if (pickedItems.length >= 3 || div.classList.contains('selected')) return;
            pickedItems.push({ name, quote: data.quotes[themeIdx], trad: data.trad });
            div.classList.add('selected'); 
            
            let popupContent = `<div style="font-size:0.85rem; color:#999; margin-bottom:10px;">å‚³çµ±å¯“æ„ï¼š${data.trad}</div><div class="quote-card"><b>âœ¨ æˆé•·ç®´è¨€</b><p>${data.quotes[themeIdx]}</p></div>`;
            
            if (pickedItems.length === 3) {
                popupContent += `<div class="seal-text">ä¸‰ä»¶æ—¢å®šï¼Œå‘½ç›¤æˆå½¢ã€‚</div>`;
                document.getElementById('popCloseBtn').innerText = "æŠ“å‘¨åœ“æ»¿ï¼Œä¸‹ä¸€æ­¥";
                document.getElementById('popCloseBtn').onclick = () => { closePopup(); toFeet(); };
            } else {
                document.getElementById('popCloseBtn').innerText = "ç¹¼çºŒæ¢ç´¢å¯¶ç‰©";
                document.getElementById('popCloseBtn').onclick = closePopup;
            }
            showPopup(popupContent);
        };
        grid.appendChild(div);
    });
}

function toFeet() {
    const container = document.getElementById('guiContainer');
    container.innerHTML = "";
    THEMES[themeIdx].strategy.forEach((s) => {
        const div = document.createElement('div');
        div.className = 'red-gui';
        div.innerHTML = `<span>${s.l}</span><b>${s.s}</b>`;
        div.onclick = () => {
            if (pickedFeets.length < 2 && !div.classList.contains('active')) {
                pickedFeets.push(s);
                div.classList.add('active');
                showPopup(`<h3 style="font-size:1.05rem; margin-bottom:12px; color:#821c1c;">ğŸ‘£ ${s.s}ï½œ${s.j}</h3><p style="text-align:left; line-height:1.7; font-size:0.95rem;">${s.d}</p>`);
                document.getElementById('popCloseBtn').innerText = "ç¹¼çºŒå„€å¼";
                if (pickedFeets.length === 2) document.getElementById('popCloseBtn').onclick = () => { closePopup(); toCert(); };
            }
        };
        container.appendChild(div);
    });
    document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
    document.getElementById('stepFeet').classList.remove('hidden');
}

function toCert() {
    const i = pickedItems, s = pickedFeets, t = THEMES[themeIdx];
    const today = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById('certContainer').innerHTML = `
        <div class="certificate">
            <div class="cert-section" id="cs1">
                <h2 class="center" style="color:#821c1c; margin:0; font-size:1.5rem;">æŠ“å‘¨ç¦®æˆè­‰æ›¸</h2>
                <p class="center" style="font-size:0.7rem; color:#999; margin-bottom:15px;">CERTIFICATE OF CAREER ANNIVERSARY</p>
                <p style="font-size:1rem;"><b>è·äººï¼š${userName}</b></p>
            </div>
            <div class="blessing-box">
                <div class="cert-section" id="cs2">
                    <p>âœ¨ <b>é€±æ­²æˆå°±ï¼š</b><br>
                    æ“æœ‰ã€Œ${i[0].name}ã€ä¹‹å§¿ï¼Œ${i[0].quote}<br>
                    å…·å‚™ã€Œ${i[1].name}ã€ä¹‹åº•ï¼Œ${i[1].quote}<br>
                    çµ‚å¾—ã€Œ${i[2].name}ã€ä¹‹ç¥ï¼Œ${i[2].quote}</p>
                </div>
                <div class="cert-section" id="cs3">
                    <p>ğŸš€ <b>æœªä¾†æ­¥å±€ï¼š</b><br>
                    æ·±è€•<b>ã€Œ${s[0].s}ã€</b>ï¼ˆ${s[0].d}ï¼‰<br>
                    ä¸¦è¡Œ<b>ã€Œ${s[1].s}ã€</b>ï¼ˆ${s[1].d}ï¼‰ã€‚</p>
                </div>
                <div class="cert-section center" id="cs4" style="font-weight:bold; color:#821c1c; margin-top:30px;">${t.wishes}</div>
            </div>
            <p class="cert-section" id="cs5" style="text-align:right; font-size:0.8rem; color:#999; margin-top:20px;">å„€å¼æ—¥æœŸï¼š${today}</p>
        </div>
    `;
    document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
    document.getElementById('stepCert').classList.remove('hidden');
    const sections = ["cs1", "cs2", "cs3", "cs4", "cs5"];
    sections.forEach((id, idx) => { setTimeout(() => document.getElementById(id).classList.add('show'), idx * 400); });
}

function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(() => { alert("é€£çµå·²è¤‡è£½ï¼Œå¿«å»åˆ†äº«çµ¦è·äººå¤¥ä¼´å§ï¼"); });
}

function manualReset() { location.reload(); }
function showPopup(html) { document.getElementById('popupBody').innerHTML = html; document.getElementById('overlay').classList.remove('hidden'); }
function closePopup() { document.getElementById('overlay').classList.add('hidden'); }
</script>
</body>
</html>